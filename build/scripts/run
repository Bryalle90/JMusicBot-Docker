#!/bin/bash
SOURCE=${BASH_SOURCE[0]}
while [ -h "$SOURCE" ]; do # resolve $SOURCE until the file is no longer a symlink
  DIR=$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )
  SOURCE=$(readlink "$SOURCE")
  [[ $SOURCE != /* ]] && SOURCE=$DIR/$SOURCE # if $SOURCE was a relative symlink, we need to resolve it relative to the path where the symlink file was located
done
SOURCE_DIR=$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )

# Set perms
if [ -d "./supervise" ]; then chmod 0777 supervise; fi

# Source Repo: https://github.com/jagrosh/MusicBot

# This will have this script check for a version of JMusicBot every
# startup (and download it if the version isn't currently downloaded)
DOWNLOAD="${AUTO_DOWNLOAD:-true}"

# Use a specific version
VERSION="${USE_VERSION:-latest}"

NOTIFY="${UPDATE_NOTIFY:-true}"

RELEASE_API_URL="https://api.github.com/repos/jagrosh/MusicBot/releases"
RELEASE_API_CONTENT=""

PL_DIR="/playlists"
JAR_DIR="/jars"
CONF_DIR="/conf"
CONF_FILE="config.txt"
SETTINGS_FILE="serversettings.json"

function mod_conf() {
    # Link config.txt
    if [ -w "$SOURCE_DIR/$CONF_FILE" ]; then
        rm -f "$SOURCE_DIR/$CONF_FILE"
    fi
    if [ ! -d "$CONF_DIR" ]; then mkdir -p "$CONF_DIR" && chmod 0666 "$CONF_DIR"; fi
    if [ ! -w "$CONF_DIR/$CONF_FILE" ]; then
        generate_conf || return 1
    fi
    printf '%s\n' "Linking: $CONF_DIR/$CONF_FILE -> $SOURCE_DIR/$CONF_FILE" >&2
    ln -s "$CONF_DIR/$CONF_FILE" "$SOURCE_DIR/$CONF_FILE"

    # Link settings json
    if [ -w "$SOURCE_DIR/$SETTINGS_FILE" ]; then
        rm -f "$SOURCE_DIR/$SETTINGS_FILE"
    fi
    if [ ! -d "$CONF_DIR" ]; then mkdir -p "$CONF_DIR" && chmod 0666 "$CONF_DIR"; fi
    if [ ! -w "$CONF_DIR/$SETTINGS_FILE" ]; then
        touch "$CONF_DIR/$SETTINGS_FILE" &&\
        chmod 0666 "$CONF_DIR/$SETTINGS_FILE" &&\
        echo "{}" >> "$CONF_DIR/$SETTINGS_FILE"
    fi
    printf '%s\n' "Linking: $CONF_DIR/$SETTINGS_FILE -> $SOURCE_DIR/$SETTINGS_FILE" >&2
    ln -s "$CONF_DIR/$SETTINGS_FILE" "$SOURCE_DIR/$SETTINGS_FILE"

    # Set token and owner
    printf '%s\n' "" >&2
    printf '%s\n' "Setting: BOT_TOKEN and BOT_OWNER" >&2
    sed -i "s/\(token =\).*/\1 ${BOT_TOKEN}/" "$CONF_DIR/$CONF_FILE"
    sed -i "s/\(owner =\).*/\1 ${BOT_OWNER}/" "$CONF_DIR/$CONF_FILE"

    # Set playlist folder
    printf '%s\n' "Setting: playlistsfolder to $PL_DIR" >&2
    if [ ! -d "$PL_DIR" ]; then mkdir -p "$PL_DIR" && chmod 0666 "$PL_DIR"; fi
    sed -i "s|\(playlistsfolder =\).*|\1 \"${PL_DIR}\"|" "$CONF_DIR/$CONF_FILE"

    # Set update notification
    printf '%s\n' "Setting: updatealerts to $NOTIFY" >&2
    sed -i "s|\(updatealerts=\).*|\1${NOTIFY}|" "$CONF_DIR/$CONF_FILE"

    printf '%s\n' ""
    return 0
}

function generate_conf() {
    local file=""
    file="$( find "$JAR_DIR" -maxdepth 1 -name "$( get_file_name "$VERSION" )" )"
    cd "$CONF_DIR" &&\
    if [[ "$DEBUG" == "true" ]]; then 
        java -verbose -Dnogui=true -jar "$file" "generate-config" || return 1
    else
        java -Dnogui=true -jar "$file" "generate-config" || return 1
    fi && { cd - || return 1; }
    return 0
}

function fetch_release_info() {
    RELEASE_API_CONTENT=$( curl -s "$RELEASE_API_URL" ) || printf '%s\n' "Error fetching release api ..."
}

function get_releases() {
    local res=""
    local -a releases=()

    if ! [ "$RELEASE_API_CONTENT" ]; then fetch_release_info; fi
    res=$( echo "$RELEASE_API_CONTENT" | jq -c '.[].tag_name' | sed -e 's/^"//' -e 's/"$//' )
    for release in $res; do 
        releases+=("$release")
    done

    echo "${releases[@]}"
}

function get_latest() {
    local -a releases=()

    for release in $( get_releases ); do 
        releases+=("$release")
    done

    echo "${releases[0]}"
}

function get_download_url() {
    local release="$1"

    if ! [ "$RELEASE_API_CONTENT" ]; then fetch_release_info; fi
    [[ "$release" == "latest" ]] && release=$( get_latest )
    echo "$RELEASE_API_CONTENT" | jq -c ".[] | select(.tag_name == \"$release\") | .assets[].browser_download_url" | sed -e 's/^"//' -e 's/"$//'
}

function is_valid_release() {
    local release="$1"
    [[ "latest" == "$release" ]] && return 0
    for r in $( get_releases ); do 
        [[ "$r" == "$release" ]] && return 0
    done
    return 1
}

function get_url() {
    local url=""

    is_valid_release "$VERSION"
    if [ $? ]; then url="$( get_download_url "$VERSION" )"; else url=""; fi

    echo "$url"
}

function get_file_name() {
    local release="$1"

    if ! [ "$RELEASE_API_CONTENT" ]; then fetch_release_info; fi
    [[ "$release" == "latest" ]] && release=$( get_latest )
    echo "$RELEASE_API_CONTENT" | jq -c ".[] | select(.tag_name == \"$release\") | .assets[].name" | sed -e 's/^"//' -e 's/"$//'
}

function download() {
    local url="$1"
    local file=""

    file="$(get_file_name "$VERSION")"

    if [ ! -d "$JAR_DIR" ]; then mkdir -p "$JAR_DIR" && chmod 0666 "$JAR_DIR"; fi
    curl -L "$url" -o "$JAR_DIR/$file" && chmod 0777 "$JAR_DIR/$file" && return 0
    return 1
}

function file_exists() {
    local file=""
    file="$1"
    [[ -f "$file" ]] && return 0 || return 1
}

function get_file() {
    [[ "$DOWNLOAD" == "true" ]] && { file_exists "$JAR_DIR/$( get_file_name "$VERSION" )" || { download "$( get_url )" || return 1; }; }
    return 0
}

function run() {
    local file=""
    file="$( find "$JAR_DIR" -maxdepth 1 -name "$( get_file_name "$VERSION" )" )"
    cd "$SOURCE_DIR" &&\
    if [[ "$DEBUG" == "true" ]]; then 
        java -verbose -Dnogui=true -jar "$file" || return 1
    else
        java -Dnogui=true -jar "$file" || return 1
    fi
    return 0
}

printf '%s\n' "------------------------- START SCRIPT -------------------------"
printf '%s\n' "AUTO_DOWNLOAD: $DOWNLOAD"
printf '%s\n' "VERSION: $VERSION"
printf '%s\n' ""

# Get jar
get_file || { printf '%s\n' "Error downloading ..." && exit 1; }

# Modify conf
if [ ! "${BOT_TOKEN}" == "" ] && [ ! "${BOT_OWNER}" == "" ]; then
    mod_conf || { printf '%s\n' "Error setting conf" && exit 1; }
else
    printf '%s\n' "Set the environment variables for BOT_TOKEN and BOT_OWNER"
    printf '%s\n' "See https://jmusicbot.com/getting-a-bot-token/"
    exit 1
fi

# Run bot
run || { printf '%s\n' "Bot error ..." && exit 1; }
printf '%s\n' "-------------------------  END SCRIPT  -------------------------"

exit 0